services:
  # ── Presidio Analyzer ────────────────────────────────────────────────────────
  presidio-analyzer:
    image: mcr.microsoft.com/presidio-analyzer:latest
    ports:
      - "5001:5001"
    environment:
      - GRPC_SERVER=presidio-anonymizer
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5001/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ── Presidio Anonymizer ──────────────────────────────────────────────────────
  presidio-anonymizer:
    image: mcr.microsoft.com/presidio-anonymizer:latest
    ports:
      - "5002:5002"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5002/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # ── API (Node.js + Fastify + SQLite) ────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: server/Dockerfile
    ports:
      - "${API_PORT:-3001}:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - HOST=0.0.0.0
      - DATA_DIR=/data
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
    volumes:
      - ${DATA_DIR:-./infra/volumes/data}:/data
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/api/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ── Worker (file watcher + Presidio pipeline) ────────────────────────────────
  worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    environment:
      - NODE_ENV=production
      - UPLOADS_DIR=/uploads
      - API_URL=http://api:3001
      - PRESIDIO_ANALYZER_URL=http://presidio-analyzer:5001
      - PRESIDIO_ANONYMIZER_URL=http://presidio-anonymizer:5002
      - TARGET_URL=${TARGET_URL:-}
      - TARGET_AUTH_HEADER=${TARGET_AUTH_HEADER:-}
      - LANGUAGE=${LANGUAGE:-en}
    volumes:
      - ${UPLOADS_DIR:-./infra/volumes/uploads}:/uploads
    depends_on:
      api:
        condition: service_healthy
      presidio-analyzer:
        condition: service_healthy
      presidio-anonymizer:
        condition: service_healthy
    restart: unless-stopped

  # ── UI (Nuxt 3 + Nuxt UI) ───────────────────────────────────────────────────
  ui:
    build:
      context: .
      dockerfile: app/Dockerfile
      args:
        - NUXT_PUBLIC_API_BASE=${NUXT_PUBLIC_API_BASE:-http://localhost:3001}
    ports:
      - "${UI_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=3000
      - NUXT_PUBLIC_API_BASE=${NUXT_PUBLIC_API_BASE:-http://localhost:3001}
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    restart: unless-stopped
